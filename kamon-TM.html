<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>家紋分類サイト（Teachable Machine + OpenCV.js）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: "Segoe UI", "Hiragino Kaku Gothic ProN", sans-serif; background:#111; color:#eee; text-align:center; margin:2rem;}
    h1 { font-size:2rem; margin-bottom:0.5rem;}
    #status { margin:1rem 0; color:#aaa;}
    input[type=file]{margin:1rem;}
    canvas{margin-top:1rem; max-width:90%; border:1px solid #444;}
    .result{margin-top:1rem; font-size:1.2rem;}
  </style>
</head>

<body>
  <h1>🏯 家紋分類サイト</h1>
  <p>画像をアップロードすると、AIが <b>丸・四角・三角・なし</b> のいずれかを判定します。</p>

  <p id="status">⏳ モデル読み込み中...</p>
  <input type="file" id="file" accept="image/*">
  <canvas id="canvas"></canvas>
  <div class="result" id="result"></div>

 <!-- TensorFlow.js -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js"></script>

<!-- Teachable Machine -->
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

<!-- OpenCV.js（安定CDN＋確認付き） -->
<script async 
  src="https://docs.opencv.org/4.x/opencv.js"
  onload="document.getElementById('status').textContent += ' ✅ OpenCV.js読み込み成功';"
  onerror="alert('⚠️ OpenCV.jsの読み込みに失敗しました。もう一度再読み込みしてください。');">
</script>


  <script>
    const MODEL_URL = "https://teachablemachine.withgoogle.com/models/JssL1cK-Y/";  // ← あなたのモデルURLに置き換え
    let tmModel;

    const statusEl = document.getElementById('status');
    const fileInput = document.getElementById('file');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const resultEl = document.getElementById('result');

    // ---- モデルを読み込む ----
    async function loadModel() {
      try {
        const modelURL = MODEL_URL + "model.json";
        const metadataURL = MODEL_URL + "metadata.json";
        tmModel = await tmImage.load(modelURL, metadataURL);
        statusEl.textContent = "✅ モデル読み込み完了！画像を選んでください。";
      } catch (err) {
        console.error(err);
        statusEl.textContent = "❌ モデル読み込み失敗：URLやネットワークを確認してください。";
      }
    }

    loadModel();

    // ---- ファイル選択時 ----
    fileInput.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file || !tmModel) return;

      const img = new Image();
      img.onload = async () => {
        // Canvasに描画
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);

        // TMモデルで推論
        const prediction = await tmModel.predict(img);
        prediction.sort((a, b) => b.probability - a.probability);
        const top = prediction[0];

        resultEl.innerHTML = `🔍 結果：<b>${top.className}</b>（確率 ${(top.probability*100).toFixed(1)}%）`;

        // OpenCVで囲みを描画（もし形があれば）
        if (typeof cv !== 'undefined') {
          const src = cv.imread(canvas);
          const gray = new cv.Mat();
          cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);
          cv.threshold(gray, gray, 120, 255, cv.THRESH_BINARY);
          const contours = new cv.MatVector();
          const hierarchy = new cv.Mat();
          cv.findContours(gray, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);
          for (let i = 0; i < contours.size(); ++i) {
            const color = new cv.Scalar(0, 255, 0, 255);
            cv.drawContours(src, contours, i, color, 2, cv.LINE_8, hierarchy, 100);
          }
          cv.imshow(canvas, src);
          src.delete(); gray.delete(); contours.delete(); hierarchy.delete();
        }
      };
      img.src = URL.createObjectURL(file);
    });
  </script>
</body>
</html>


